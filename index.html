<html>

<head>
    <style>
        #contenedor {
            position: relative;
        }

        canvas {
            position: absolute;
            top: 0px;
            left: 0px;
        }
    </style>
</head>

<body>
    <div id="contenedor">
        <canvas id="laberinto" width="2048px" height="2048px"></canvas>
        <canvas id="npc" width="2048px" height="2048px"></canvas>
        <canvas id="sensores" width="2048px" height="2048px"></canvas>
    </div>
    <script>
        function Npc(x, y, angulo, velocidad) {
            this.posx = x;
            this.posy = y;
            this.angulo = angulo;
            this.velocidad = velocidad;
            this.muevete = function () {
                this.posx += Math.cos(this.angulo) * this.velocidad
                this.posy += Math.sin(this.angulo) * this.velocidad
                this.giraaleatorio();
                this.colision();
            }
            this.giraaleatorio = function () {
                this.angulo += (Math.random() - 0.5) * 0.1
            }
            this.colision = function () {
                // 30 grados
                var pregunta = contextolaberinto.getImageData(this.posx + Math.cos(this.angulo + Math.PI / 6) * 10, this.posy + Math.sin(this.angulo + Math.PI / 6) * 10, 1, 1)
                if (pregunta.data[0] < 50) { this.angulo -= 0.1 }
                // 60 grados
                var pregunta = contextolaberinto.getImageData(this.posx + Math.cos(this.angulo + Math.PI / 3) * 10, this.posy + Math.sin(this.angulo + Math.PI / 3) * 10, 1, 1)
                if (pregunta.data[0] < 50) { this.angulo -= 0.2 }
                // -30 grados
                var pregunta = contextolaberinto.getImageData(this.posx + Math.cos(this.angulo - Math.PI / 6) * 10, this.posy + Math.sin(this.angulo - Math.PI / 6) * 10, 1, 1)
                if (pregunta.data[0] < 50) { this.angulo += 0.1 }
                // -60 grados
                var pregunta = contextolaberinto.getImageData(this.posx + Math.cos(this.angulo - Math.PI / 3) * 10, this.posy + Math.sin(this.angulo - Math.PI / 3) * 10, 1, 1)
                if (pregunta.data[0] < 50) { this.angulo += 0.2 }
                // 0 grados
                var pregunta = contextolaberinto.getImageData(this.posx + Math.cos(this.angulo) * 10, this.posy + Math.sin(this.angulo) * 10, 1, 1)
                if (pregunta.data[0] < 50) { this.angulo += 0.6 }
            }
        }
        var numeroNpc = 100;
        var npcs = new Array();
        var laberinto = new Image();
        laberinto.src = "images/maze.jpg";
        var temporizador;
        var contextolaberinto = document.getElementById("laberinto").getContext("2d");
        var contextonpc = document.getElementById("npc").getContext("2d");
        var contextosensores = document.getElementById("sensores").getContext("2d");
        setTimeout("inicio()", 1000)
        function inicio() {
            for (var i = 0; i < numeroNpc; i++) {
                npcs[i] = new Npc(Math.random() * 2048, Math.random() * 2048, Math.random() * Math.PI * 2, Math.random() * 2 + 2);
            }
            contextolaberinto.drawImage(laberinto, 0, 0)
            temporizador = setTimeout("bucle()", 1000)
            contextonpc.fillStyle = "red"
            contextosensores.fillStyle = "green"
        }
        function bucle() {
            contextonpc.clearRect(0, 0, 2048, 2048)
            contextosensores.clearRect(0, 0, 2048, 2048)
            for (var i = 0; i < numeroNpc; i++) {
                // Pinto el npc
                contextonpc.beginPath()
                contextonpc.arc(npcs[i].posx, npcs[i].posy, 4, 0, Math.PI * 2, true);
                contextonpc.fill();
                contextonpc.closePath();
                // Pinto sus sensores
                // 30 grados
                contextosensores.beginPath()
                contextosensores.arc(npcs[i].posx + Math.cos(npcs[i].angulo + Math.PI / 6) * 10, npcs[i].posy + Math.sin(npcs[i].angulo + Math.PI / 6) * 10, 2, 0, Math.PI * 2, true);
                contextosensores.fill();
                contextosensores.closePath();
                // 60 grados
                contextosensores.beginPath()
                contextosensores.arc(npcs[i].posx + Math.cos(npcs[i].angulo + Math.PI / 3) * 10, npcs[i].posy + Math.sin(npcs[i].angulo + Math.PI / 3) * 10, 2, 0, Math.PI * 2, true);
                contextosensores.fill();
                contextosensores.closePath();
                // -30 grados
                contextosensores.beginPath()
                contextosensores.arc(npcs[i].posx + Math.cos(npcs[i].angulo - Math.PI / 6) * 10, npcs[i].posy + Math.sin(npcs[i].angulo - Math.PI / 6) * 10, 2, 0, Math.PI * 2, true);
                contextosensores.fill();
                contextosensores.closePath();
                // -60 grados
                contextosensores.beginPath()
                contextosensores.arc(npcs[i].posx + Math.cos(npcs[i].angulo - Math.PI / 3) * 10, npcs[i].posy + Math.sin(npcs[i].angulo - Math.PI / 3) * 10, 2, 0, Math.PI * 2, true);
                contextosensores.fill();
                contextosensores.closePath();
                // Vamos a hacer que se muevan
                npcs[i].muevete();
            }
            clearTimeout(temporizador);
            temporizador = setTimeout("bucle()", 1)

        }
    </script>
</body>

</html>